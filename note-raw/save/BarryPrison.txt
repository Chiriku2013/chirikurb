-- Chế độ Map
getgenv().Map = "1" -- đổi "1" hoặc "2"

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")

local LocalPlayer = Players.LocalPlayer

-- Toạ độ
local Map1Target = Vector3.new(-3543.80469, 1076.37036, -453.318512)
local Map2RayGunMid = Vector3.new(1046.32043, 397.748322, -510.007385)
local Map2BeforeGate = Vector3.new(1261.442993, 396.065643, -657.96228)
local Map2AfterBoss = Vector3.new(1465.67358, 329.464233, -664.305664)
local FlySpeed = 1

-- === Noclip ===
local function EnableNoclip()
RunService.Stepped:Connect(function()
if LocalPlayer.Character then
for _,v in pairs(LocalPlayer.Character:GetDescendants()) do
if v:IsA("BasePart") then
v.CanCollide = false
end
end
end
end)
end

-- === Tween fly ===
local function FlyTo(pos, speed)
local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local dist = (hrp.Position - pos).Magnitude
local t = math.max(0.05, dist / speed)
local tween = TweenService:Create(hrp, TweenInfo.new(t, Enum.EasingStyle.Linear), {CFrame = CFrame.new(pos)})
tween:Play()
tween.Completed:Wait()
end

-- === Auto Click ===
local clicking = false
local function StartClicking()
if clicking then return end
clicking = true
task.spawn(function()
while clicking do
VirtualUser:Button1Down(Vector2.new(0,0))
task.wait(0.05)
VirtualUser:Button1Up(Vector2.new(0,0))
end
end)
end
local function StopClicking() clicking = false end

-- === Boss finder (BarryUFOBoss) ===
local function FindBoss()
for _,v in pairs(workspace:GetDescendants()) do
if v:IsA("Model") and v.Name == "BarryUFOBoss" and v:FindFirstChild("Humanoid") then
if v.Humanoid.Health > 0 then
return v
end
end
end
end

-- === Auto equip RayGun ===
local function EquipRayGun()
task.spawn(function()
while task.wait(0.5) do
local char = LocalPlayer.Character
if char and not char:FindFirstChild("RayGun") then
local backpack = LocalPlayer:FindFirstChild("Backpack")
if backpack and backpack:FindFirstChild("RayGun") then
char.Humanoid:EquipTool(backpack.RayGun)
end
end
end
end)
end

-- === Hướng RayGun về boss ===
local function AimAtBoss(boss)
task.spawn(function()
while boss and boss.Parent and boss:FindFirstChild("Humanoid") and boss.Humanoid.Health > 0 do
local char = LocalPlayer.Character
if char and char:FindFirstChild("HumanoidRootPart") and boss:FindFirstChild("HumanoidRootPart") then
local hrp = char.HumanoidRootPart
if char:FindFirstChild("RayGun") then
local dir = (boss.HumanoidRootPart.Position - hrp.Position).Unit
hrp.CFrame = CFrame.new(hrp.Position, hrp.Position + dir)
end
end
task.wait(0.05)
end
end)
end

-- === Pick RayGun (Model) ===
local function PickRayGun()
local weaponSpawn = workspace:WaitForChild("HardModeObjects")
:WaitForChild("ClickObjects")
:WaitForChild("WeaponSpawn")
local raygunModel = weaponSpawn:WaitForChild("RayGun")

if raygunModel and raygunModel:IsA("Model") then  
    local targetPart = raygunModel:FindFirstChild("Handle") or raygunModel.PrimaryPart or raygunModel:FindFirstChildWhichIsA("BasePart")  
    if targetPart then  
        FlyTo(targetPart.Position, FlySpeed)  

        local hrp = LocalPlayer.Character:WaitForChild("HumanoidRootPart")  
        repeat  
            firetouchinterest(hrp, targetPart, 0)  
            task.wait(0.2)  
            firetouchinterest(hrp, targetPart, 1)  
            task.wait(0.2)  
        until LocalPlayer.Backpack:FindFirstChild("RayGun") or (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("RayGun"))  

        return true  
    end  
end  
return false

end

-- === Main Logic ===
task.spawn(function()
    EnableNoclip() -- bật noclip

    if getgenv().Map == "1" then
        FlyTo(Map1Target, FlySpeed)

    elseif getgenv().Map == "2" then
        -- Map 2: chỉ auto noclip và FireServer
        task.wait(1) -- chờ character load xong

        -- FireServer LeaderBoardTime
        local args1 = {2, 309, "00:00"}
        game:GetService("ReplicatedStorage")
            :WaitForChild("ShopAssetsFolder")
            :WaitForChild("LeaderBoardFolder")
            :WaitForChild("LeaderBoardTime")
            :FireServer(unpack(args1))

        -- FireServer StageChange
        local args2 = {20, 2}
        game:GetService("ReplicatedStorage")
            :WaitForChild("RemoteEventsFolder")
            :WaitForChild("StageChange")
            :FireServer(unpack(args2))

        print("✅ Map 2: FireServer đã chạy xong")
    end
end)